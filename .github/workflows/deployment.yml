name: deployment workflow

on:
    push:
        branches:
            - master

    workflow_dispatch:

jobs:
    run_pull:
        name: run pull
        runs-on: ubuntu-latest

        steps:
            - name: install ssh keys
              # check this thread to understand why its needed:
              # https://stackoverflow.com/a/70447517
              run: |
                  install -m 600 -D /dev/null ~/.ssh/id_rsa
                  echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
                  ssh-keyscan -H ${{ secrets.SSH_HOST }} > ~/.ssh/known_hosts
            - name: connect and pull
              run: ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "cd ${{ secrets.WORK_DIR }} && sudo git fetch --all && sudo git reset --hard origin/${{ secrets.MAIN_BRANCH }} && ${{ secrets.AFTER_GIT_COMMAND }} ${{ secrets.WORK_DIR }} && npm run install:prod && npm run build && exit"
            - name: cleanup
              run: rm -rf ~/.ssh